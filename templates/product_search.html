{% extends "base.html" %}
{% block content %}
<div class="card shadow-sm mb-4">
  <div class="card-body">
    <h4 class="card-title mb-4">Advanced Product Search</h4>
    <form method="get" action="{{ url_for('product_search') }}">
      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label">Search</label>
          <input type="text" name="q" class="form-control" placeholder="Product name, SKU..." value="{{ query }}">
        </div>
        <div class="col-md-2">
          <label class="form-label">Category</label>
          <select name="category" class="form-select">
            <option value="">All Categories</option>
            {% for cat in categories %}
              <option value="{{ cat }}" {% if selected_category == cat %}selected{% endif %}>{{ cat }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label">Size</label>
          <select name="size" class="form-select">
            <option value="">All Sizes</option>
            {% for s in sizes %}
              <option value="{{ s }}" {% if selected_size == s %}selected{% endif %}>{{ s }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label">Color</label>
          <input type="text" name="color" class="form-control" placeholder="Color..." value="{{ selected_color }}">
        </div>
        <div class="col-md-2 d-flex align-items-end">
          <button type="submit" class="btn btn-primary w-100">Search</button>
        </div>
      </div>
    </form>
  </div>
</div>

<div class="card shadow-sm">
  <div class="card-body">
    <h5 class="card-title">Search Results ({{ products|length }} products)</h5>
    <div class="row g-4 mt-2">
      {% for item in products %}
      <div class="col-md-6 col-lg-4">
        <div class="card h-100">
          {% if item.product.image_url %}
            {% if item.product.image_url.startswith('http') %}
            <img src="{{ item.product.image_url }}" class="card-img-top" alt="{{ item.product.name }}" style="height: 200px; object-fit: cover;">
            {% else %}
            <img src="{{ url_for('static', filename=item.product.image_url) }}" class="card-img-top" alt="{{ item.product.name }}" style="height: 200px; object-fit: cover;">
            {% endif %}
          {% else %}
          <div class="card-img-top bg-light d-flex align-items-center justify-content-center" style="height: 200px;">
            <span class="text-muted">No Image</span>
          </div>
          {% endif %}
          <div class="card-body">
            <h6 class="card-title">{{ item.product.name }}</h6>
            <p class="card-text small text-muted mb-2">
              <strong>SKU:</strong> {{ item.product.sku }}<br>
              {% if item.product.category %}<strong>Category:</strong> {{ item.product.category }}<br>{% endif %}
              {% if item.product.size %}<strong>Size:</strong> {{ item.product.size }}<br>{% endif %}
              {% if item.product.color %}<strong>Color:</strong> {{ item.product.color }}<br>{% endif %}
              {% if item.product.price %}<strong>Price:</strong> ${{ "%.2f"|format(item.product.price) }}{% endif %}
            </p>
            {% if item.product.description %}
            <p class="card-text small">{{ item.product.description[:100] }}{% if item.product.description|length > 100 %}...{% endif %}</p>
            {% endif %}
            <div class="mt-2">
              <small class="text-muted"><strong>Inventory:</strong></small>
              <ul class="list-unstyled small mb-0">
                {% for store_name, qty, is_low in item.inventory %}
                  <li>
                    {{ store_name }}: 
                    <span class="badge {% if is_low %}bg-warning text-dark{% else %}bg-success{% endif %}">
                      {{ qty }} units
                    </span>
                  </li>
                {% endfor %}
                {% if item.inventory|length == 0 %}
                  <li class="text-muted">No inventory</li>
                {% endif %}
              </ul>
            </div>
          </div>
          <div class="card-footer bg-white">
            <a href="{{ url_for('product_barcode', product_id=item.product.id) }}" class="btn btn-sm btn-outline-primary">
              Generate Barcode
            </a>
          </div>
        </div>
      </div>
      {% endfor %}
      {% if products|length == 0 %}
      <div class="col-12">
        <p class="text-muted text-center">No products found. Try adjusting your search filters.</p>
      </div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}
